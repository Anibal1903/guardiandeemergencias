<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Guardi√°n de Emergencias - Prevenci√≥n</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #1a1a1a; color: #333; }
        header { background: #d32f2f; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        
        /* Estilos de Tarjetas */
        .info-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-top: 5px solid #2196F3; text-align: center; }
        .info-card h3 { color: #d32f2f; margin-top: 0; }
        
        .btn-opcion { background: #f8f9fa; color: #333; border: 1px solid #ddd; padding: 15px; margin: 8px 0; display: block; width: 100%; text-align: left; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.3s; font-weight: 500; }
        .btn-opcion:hover { background: #ffebee; border-color: #d32f2f; transform: scale(1.01); }
        
        .stats { background: #333; color: white; padding: 15px; border-radius: 8px; margin: 20px auto; max-width: 1200px; }
        .progress-bar { background: #555; border-radius: 10px; height: 15px; width: 100%; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: #4caf50; height: 100%; width: 0%; transition: width 0.5s; }
        
        #feedback { font-weight: bold; margin-top: 15px; padding: 15px; border-radius: 5px; }
        button.main-btn { background: #d32f2f; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button.main-btn:hover { background: #b71c1c; }
        button.main-btn:disabled { background: #555; cursor: not-allowed; }
        
        .vidas-container { font-size: 24px; color: #ff5252; }
        #timer-display { font-weight: bold; color: #ffeb3b; background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 5px; }
    </style>
</head>
<body>
    
<header>
    <h1>Guardi√°n de Emergenciasüî•</h1>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span id="txt-nivel" style="font-weight: bold;">Nivel 1: Hogar</span>
        <span id="vidas-display" class="vidas-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
        <span id="timer-display">‚è±Ô∏è 30s</span>
        <strong>Puntos: <span id="txt-puntos">0</span></strong>
    </div>
</header>

<div id="modal-registro" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; justify-content: center; align-items: center; font-family: sans-serif;">
    <div style="background: #ffffff; padding: 40px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border-top: 8px solid #e63946;">
        <h2 style="color: #1a1a1a; margin-bottom: 10px;">üë®‚Äçüöí Registro de Guardi√°n</h2>
        <p style="color: #666; margin-bottom: 25px;">Identif√≠cate para validar tus certificaciones.</p>
        
        <input type="text" id="nombre-usuario" placeholder="Nombre Completo" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
        
        <input type="text" id="organizacion-usuario" placeholder="Escuela / Empresa (Opcional)" style="width: 100%; padding: 12px; margin-bottom: 25px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
        
        <button onclick="guardarIdentidad()" style="width: 100%; padding: 15px; background: #e63946; color: white; border: none; border-radius: 5px; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s;">
            INGRESAR A GUARDIA
        </button>
    </div>
</div>

    <div id="pantalla-inicio" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #1a1a1a; z-index: 2500; display: none; flex-direction: column; justify-content: center; align-items: center;">
    <h1 style="color: white; margin-bottom: 30px; font-size: 3rem; text-align: center; font-family: sans-serif;">üë®‚Äçüöí GUARDi√ÅN DE EMERGENCIAS</h1>
    
    <button id="btn-comenzar" onclick="iniciarSimulacro()" 
        style="padding: 25px 50px; background-color: #e63946; color: white; border-radius: 50px; cursor: pointer; border: none; font-weight: bold; font-size: 24px; box-shadow: 0 0 20px rgba(230,57,70,0.6);">
        COMENZAR SIMULACRO
    </button>
    </div>

<div class="container" id="selector-niveles">
    <h2 style="text-align:center; color:white; margin-bottom:30px; font-size: 2rem;">SELECCIONA TU √ÅMBITO DE DESPLIEGUE</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div class="info-card">
            <h3>Nivel 1: Hogar</h3>
            <p>Prevenci√≥n de incendios dom√©sticos y accidentes caseros.</p>
            <button class="main-btn" onclick="seleccionarAmbito(1)">INICIAR DESPLIEGUE</button>
        </div>
        <div class="info-card">
            <h3>Nivel 2: Escuela</h3>
            <p>Protocolos de evacuaci√≥n y seguridad educativa.</p>
            <button class="main-btn" onclick="seleccionarAmbito(2)">INICIAR DESPLIEGUE</button>
        </div>
        <div class="info-card">
            <h3>Nivel 3: Empresa</h3>
            <p>Seguridad industrial, tableros y extintores.</p>
            <button class="main-btn" onclick="seleccionarAmbito(3)">INICIAR DESPLIEGUE</button>
        </div>
        <div class="info-card">
            <h3>Nivel 4: Rescate</h3>
            <p>Accidentes en ruta y protocolo PAS.</p>
            <button class="main-btn" onclick="seleccionarAmbito(4)">INICIAR DESPLIEGUE</button>
        </div>
        <div class="info-card" style="border-top-color: #ffeb3b;">
            <h3>Nivel 5: MatPel</h3>
            <p>Riesgos qu√≠micos y biol√≥gicos (Avanzado).</p>
            <button class="main-btn" onclick="seleccionarAmbito(5)">INICIAR DESPLIEGUE</button>
        </div>
    </div>
</div>

<div id="simulador" style="display: none; background: #2c3e50; color: white; padding: 40px; border-radius: 20px; max-width: 850px; margin: 30px auto; border: 5px solid #d32f2f; box-shadow: 0 15px 40px rgba(0,0,0,0.6);">
    <h2 id="scenario-question" style="text-align: center; font-size: 1.8rem; margin-bottom: 30px; line-height: 1.4;">
        Cargando situaci√≥n...
    </h2>
    
    <div id="options-container"></div>

    <div id="feedback"></div>

    <button id="btn-siguiente" onclick="siguientePregunta()" 
        style="display:none; margin: 30px auto 0; background: #2e7d32; color: white; border: none; padding: 18px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.2rem; width: 100%;">
        CONTINUAR OPERACI√ìN ‚ûî
    </button>
</div>

<div class="stats">
        <h4>Tu Progreso Global</h4>
        <div class="progress-bar">
        <div id="bar-fill" class="progress-fill" style="width: 0%;"></div>
    </div>
        <p id="progress-text">¬°Completa escenarios para subir de rango!</p>
    </div>

<div id="pantalla-certificado" style="display:none; text-align:center; padding:50px; border:15px double #b71c1c; background: #fff; max-width: 850px; margin: 30px auto; border-radius: 5px; color: #1a1a1a; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.2); font-family: 'Georgia', serif;">
    
    <div style="position: absolute; top: 10px; left: 10px; font-size: 30px; color: #b71c1c; opacity: 0.3;">üõ°Ô∏è</div>
    <div style="position: absolute; top: 10px; right: 10px; font-size: 30px; color: #b71c1c; opacity: 0.3;">üõ°Ô∏è</div>

    <h1 style="color:#b71c1c; margin-top: 0; font-size: 2.8rem; font-family: 'Arial Black', sans-serif; text-transform: uppercase; border-bottom: 3px solid #b71c1c; padding-bottom: 5px; display: inline-block;">
        Guardi√°n de Emergencias
    </h1>
    
    <h3 style="color: #444; letter-spacing: 8px; font-weight: bold; margin-top: 15px; font-family: sans-serif;">DIPLOMA DE HONOR</h3>
    
    <div style="margin: 40px 0;">
        <p style="font-size:22px; font-style: italic;">Se otorga la presente distinci√≥n al Guardi√°n:</p>
        <h2 id="diploma-nombre" style="font-size: 3rem; color: #1a1a1a; border-bottom: 2px solid #333; display: inline-block; padding: 0 40px; margin: 10px 0; font-family: 'Times New Roman', serif;">---</h2>
        <p style="font-size:18px; margin-top: 10px;">Perteneciente a la organizaci√≥n: <strong id="diploma-org" style="color: #b71c1c;">---</strong></p>
    </div>
    
    <p style="font-size:20px; line-height: 1.6; max-width: 85%; margin: 0 auto; font-family: sans-serif; color: #555;">
        "Por haber demostrado un compromiso excepcional con la seguridad ciudadana y la prevenci√≥n, completando satisfactoriamente el entrenamiento de nivel b√°sico."
    </p>

    <div style="display: flex; justify-content: space-around; align-items: center; margin-top: 50px;">
        <div style="text-align: left; border-top: 1px solid #aaa; padding-top: 10px;">
            <p style="margin:0; font-size: 14px; color: #777;">Otorgado el:</p>
            <strong id="diploma-fecha" style="font-size: 16px;">-- de --- de ----</strong>
        </div>

        <div class="sello-brillante" style="width: 140px; height: 140px; background: radial-gradient(circle, #e63946 0%, #b71c1c 100%); border-radius: 50%; border: 6px double #ffd700; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ffd700; box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 10; position: relative;">
            <span style="font-size: 40px; filter: drop-shadow(0 2px 2px black);">üë®‚Äçüöí</span>
            <span style="font-size: 11px; font-weight: bold; text-align: center; line-height: 1;">CERTIFICACI√ìN<br>VALIDADA<br>POR IA</span>
            <div style="position: absolute; width: 150px; height: 150px; border: 2px dotted #ffd700; border-radius: 50%; top: -11px; left: -11px; opacity: 0.5;"></div>
        </div>

        <div style="text-align: center; border-top: 1px solid #333; padding-top: 10px;">
            <span style="font-family: 'Brush Script MT', cursive; font-size: 24px; color: #1a1a1a;">Guardi√°n IA v3.0</span><br>
            <small style="color: #777; letter-spacing: 2px;">COMANDO DE PREVENCI√ìN</small>
        </div>
    </div>
</div>

<div id="contenedor-boton-ia" style="display:none; text-align: center; margin-bottom: 50px;">
    <button class="main-btn" onclick="continuarEntrenamientoIA()" style="background: #2196F3; padding: 20px 40px; font-size: 1.2rem; box-shadow: 0 10px 20px rgba(33, 150, 243, 0.4);">
        ACCEDER AL NIVEL AVANZADO (IA) ‚ûî
    </button>
</div>

<style>
    /* Estilos corregidos para que NO se vean en pantalla */
    @keyframes brilloMetalico {
        0% { left: -150%; }
        50% { left: 150%; }
        100% { left: 150%; }
    }

    .sello-brillante {
        position: relative;
        overflow: hidden;
    }

    .sello-brillante::after {
        content: "";
        position: absolute;
        top: 0; left: -150%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transform: skewX(-20deg);
        animation: brilloMetalico 3s infinite;
    }

    #modal-nuevo-diseno {
        display: flex; position: fixed; 
        top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); z-index: 5000; 
        align-items: center; justify-content: center; backdrop-filter: blur(10px);
    }

    .modal-contenido-fire {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    border-bottom: 8px solid #d32f2f;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    position: relative;
}
.casco-container {
    font-size: 50px;
    margin-top: -60px;
    background: white;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 4px solid #fff;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<div id="modal-nuevo-diseno">
    <div class="modal-contenido-fire">
        <div class="casco-container">üë®‚Äçüöí</div>
        <h2 style="color:#d32f2f; margin-top:25px; font-family: sans-serif; font-weight: 900;">üö® LECCI√ìN DEL D√çA</h2>
        <hr style="border: 0; border-top: 2px solid #eee; margin: 15px 0;">
        <p id="texto-consejo-ia" style="font-size: 1.2rem; color: #333; line-height: 1.6; font-style: italic;">
            Cargando sabidur√≠a...
        </p>
<button class="main-btn" onclick="cerrarConsejoYMostrarInicio()" 
        style="background: #d32f2f; color: white; border: none; padding: 12px 35px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 15px;">
    ¬°ENTENDIDO, CAPIT√ÅN!
</button>
    </div>
</div>

<script>
    // BASE DE DATOS COMPLETA
    const baseDeDatosEscenarios = [
        // NIVEL 1 - HOGAR
       { id: 1, nivel: 1, ambito: "Hogar", escenario: "Se produce un peque√±o incendio en una sart√©n con aceite.", opciones: ["Echar agua inmediatamente", "Tapar la sart√©n y apagar el fuego", "Mover la sart√©n al patio"], correcta: 1 },
       { id: 2, nivel: 1, ambito: "Hogar", escenario: "Un enchufe comienza a largar chispas.", opciones: ["Cortar la energ√≠a y desenchufar", "Echarle agua", "Cubrirlo con una tela"], correcta: 0 },
       { id: 3, nivel: 1, ambito: "Hogar", escenario: "Hay humo saliendo del horno el√©ctrico.", opciones: ["Abrir el horno inmediatamente", "Desenchufar y mantener cerrado", "Dejar que siga en funcionamiento"], correcta: 1 },
       { id: 4, nivel: 1, ambito: "Hogar", escenario: "Tienes que salir a realizar tr√°mites, regresas r√°pido y tiene hornallas encendidas.", opciones: ["Avisas a tu hijo que est√° con el celular", "Te vas y no avisas", "La apagas y enciendes al regresar"], correcta: 2 },
       { id: 5, nivel: 1, ambito: "Hogar", escenario: "Se genera un incendio en una habitaci√≥n.", opciones: ["Intento apagarlo", "Abro puertas y ventanas", "LLamo a bomberos e intento apagarlo"], correcta: 2 },
       { id: 6, nivel: 1, ambito: "Hogar", escenario: "Detect√°s olor a gas en la cocina.", opciones: ["Encender la luz", "Ventilar y cerrar la llave de gas", "Usar el celular"], correcta: 1 },
       { id: 7, nivel: 1, ambito: "Hogar", escenario: "Un calefactor est√° muy cerca de muebles.", opciones: ["Apagarlo y alejarlo", "Bajar la temperatura","Nada, es normal"], correcta: 0 },
       { id: 8, nivel: 1, ambito: "Hogar", escenario: "Un ni√±o juega con f√≥sforos.", opciones: ["Ignorar", "Dejarlo aprender", "Quitarlos y explicar el riesgo" ], correcta: 2 },
       { id: 9, nivel: 1, ambito: "Hogar", escenario: "Se corta la luz y us√°s velas.", opciones: ["Colocarlas sobre un mesa con mantel", "Ubicarlas dentro de un frasco", "Dejarlas y dormir"], correcta: 1 },
       { id: 10, nivel: 1, ambito: "Hogar", escenario: "Una estufa a gas no tiene ventilaci√≥n.", opciones: ["Usarla igual", "Apagarla y ventilar", "Usarla y ventilar"], correcta: 1 },
       { id: 11, nivel: 1, ambito: "Hogar", escenario: "Hay acumulaci√≥n de cables sobrecargados.", opciones: ["Usar una zapatilla m√°s", "Distribuir la carga", , "Ignorarlo, es normal"], correcta: 1 },
       { id: 12, nivel: 1, ambito: "Hogar", escenario: "Un aerosol se calienta cerca del fuego.", opciones: ["Pincharlo", "Dejarlo", "Alejarlo del calor"], correcta: 2 },
       { id: 13, nivel: 1, ambito: "Hogar", escenario: "Una plancha queda enchufada.", opciones: ["Desenchufarla y guardarla", "Desenchufarla y dejarla en lugar seguro",  "Dejarla enchufada"], correcta: 1 },
       { id: 14, nivel: 1, ambito: "Hogar", escenario: "Se prende fuego un papel.", opciones: ["Apagarlo r√°pidamente", "Dejarlo consumir", "Soplar"], correcta: 0 },
       { id: 15, nivel: 1, ambito: "Hogar", escenario: "Una salida est√° bloqueada.", opciones: ["Recordarla", "Ignorar", "Liberarla"], correcta: 2 },
       { id: 16, nivel: 1, ambito: "Hogar", escenario: "Una parrilla se usa dentro de la casa.", opciones: ["Abrir ventanas", "Apagarla y sacarla", "Continuar sin hacer nada"], correcta: 1 },
       { id: 17, nivel: 1, ambito: "Hogar", escenario: "Un cargador se calienta demasiado.", opciones: ["Ponerlo bajo una almohada", "Seguir cargando", "Desenchufarlo"], correcta: 2 },
       { id: 18, nivel: 1, ambito: "Hogar", escenario: "Enciendo el lavarropas y me voy a trabajar.", opciones: ["Siempre lo hice, no pasa nada", "La conexi√≥n el√©ctrica est√° bien", "Apagar y lavar al regreso"], correcta: 2 },
       { id: 19, nivel: 1, ambito: "Hogar", escenario: "Una frazada toca una estufa.", opciones: ["Alejarla", "Mojarla", "Ignorar"], correcta: 0 },
       { id: 20, nivel: 1, ambito: "Hogar", escenario: "No hay matafuego en casa.", opciones: ["Usar agua siempre", "Adquirir uno", "No es necesario"], correcta: 1 },
        
        // NIVEL 2 - ESCUELA
        { id: 21, nivel: 2, ambito: "Escuela", escenario: "Se activa la alarma de incendio durante clase.", opciones: ["Correr", "Salir ordenadamente", "Esconderse"], correcta: 1 },
        { id: 22, nivel: 2, ambito: "Escuela", escenario: "Un alumno detecta humo en el pasillo.", opciones: ["Avisar inmediatamente a un adulto", "Abrir ventanas", "Ignorarlo"], correcta: 0 },
        { id: 23, nivel: 2, ambito: "Escuela", escenario: "Una salida de emergencia est√° bloqueada.", opciones: ["Intentar usarla igual", "Esperar una emergencia", "Informar a la direcci√≥n"], correcta: 2 },
        { id: 24, nivel: 2, ambito: "Escuela", escenario: "Un matafuego no est√° se√±alizado.", opciones: ["Moverlo de lugar", "Solicitar se√±alizaci√≥n", "Ignorarlo"], correcta: 1 },
        { id: 25, nivel: 2, ambito: "Escuela", escenario: "Durante un simulacro un alumno corre.", opciones: ["Seguirlo", "Gritarle", "Indicarle que camine"], correcta: 2},
        { id: 26, nivel: 2, ambito: "Escuela", escenario: "Se produce un principio de incendio en laboratorio.", opciones: ["Intentar apagar sin capacitaci√≥n", "Cerrar el aula", "Evacuar y avisar"], correcta: 2 },
        { id: 27, nivel: 2, ambito: "Escuela", escenario: "Cables el√©ctricos est√°n deteriorados.", opciones: ["Informar y no usarlos", "Usarlos con cuidado", "Cubrirlos con cinta"], correcta: 0},
        { id: 28, nivel: 2, ambito: "Escuela", escenario: "Un alumno juega con un encendedor.", opciones: ["Re√≠rse", "Retirarlo y avisar", "Ignorarlo"], correcta: 1 },
        { id: 29, nivel: 2, ambito: "Escuela", escenario: "Se corta la luz en horario escolar.", opciones: ["Correr hacia la salida", "Mantener la calma", "Salir solo del aula"], correcta: 1 },
        { id: 30, nivel: 2, ambito: "Escuela", escenario: "Un docente desconoce el plan de evacuaci√≥n.", opciones: ["Improvisar", "Ignorarlo", "Informar y Capacitarse"], correcta: 2 },
        { id: 31, nivel: 2, ambito: "Escuela", escenario: "Material inflamable mal almacenado.", opciones: ["Reubicarlo correctamente", "Alejar alumnos", "Dejarlo"], correcta: 0 },
        { id: 32, nivel: 2, ambito: "Escuela", escenario: "Un simulacro no se realiza hace a√±os.", opciones: ["Esperar emergencia", "Solicitar uno", "No es necesario"], correcta: 1 },
        { id: 33, nivel: 2, ambito: "Escuela", escenario: "Puertas de emergencia cerradas con llave.", opciones: ["Mantenerlas desbloqueadas", "Abrir solo en emergencia", "Ignorarlo"], correcta: 0 },
        { id: 34, nivel: 2, ambito: "Escuela", escenario: "Humo en el aula.", opciones: ["Guardar los √∫tiles en mochilas", "Buscar origen sin avisar", "Evacuar inmediatamente de manera controlada"], correcta: 2 },
        { id: 35, nivel: 2, ambito: "Escuela", escenario: "Extintor vencido.", opciones: ["Solicitar recarga", "Usarlo igual", "Quitar y guardarlo"], correcta: 0 },
        { id: 36, nivel: 2, ambito: "Escuela", escenario: "Escalera bloqueada con sillas.", opciones: ["Pasar igual por el espacio que queda", "Dejarla", "Despejarla"], correcta: 2 },
        { id: 37, nivel: 2, ambito: "Escuela", escenario: "Fuego en un tacho de basura.", opciones: ["Avisar y usar agua o extintor", "Patearlo", "Correr"], correcta: 0 },
        { id: 38, nivel: 2, ambito: "Escuela", escenario: "Alumnos empujan durante evacuaci√≥n.", opciones: ["Acelerar", "Ignorar", "Detener y ordenar"], correcta: 2 },
        { id: 39, nivel: 2, ambito: "Escuela", escenario: "No hay planos de evacuaci√≥n visibles.", opciones: ["Explicarlo oralmente", "Solicitar colocaci√≥n", "No es necesario"], correcta: 1 },
        { id: 40, nivel: 2, ambito: "Escuela", escenario: "Se produce un incendio y alarma no funciona.", opciones: ["Repararla", "Avisar a gritos", "Ir por Aulas y Oficinas avisando"], correcta: 2 },
       
        // NIVEL 3 - EMPRESA
        { id: 41, nivel: 3, ambito: "Empresa", escenario: "Se detecta humo en el √°rea de producci√≥n.", opciones: ["Continuar trabajando", "Activar alarma y evacuar", "Abrir ventanas"], correcta: 1 },
        { id: 42, nivel: 3, ambito: "Empresa", escenario: "Un empleado no conoce donde es el punto de encuentro en caso de emergencia.", opciones: ["Ignorarlo", "Capacitarlo", "Asignarle una funci√≥n"], correcta: 1 },
        { id: 43, nivel: 3, ambito: "Empresa", escenario: "Material inflamable mal rotulado.", opciones: ["Corregir rotulaci√≥n", "Tachar sin avisar", "Usarlo igual"], correcta: 0 },
        { id: 44, nivel: 3, ambito: "Empresa", escenario: "Salida de emergencia obstruida.", opciones: ["Avisar despu√©s", "Usar otra", "Liberarla"], correcta: 2 },
        { id: 45, nivel: 3, ambito: "Empresa", escenario: "Incendio el√©ctrico en tablero.", opciones: ["Echar agua", "Cortar energ√≠a y usar extintor adecuado", "Salir corriendo"], correcta: 1 },
        { id: 46, nivel: 3, ambito: "Empresa", escenario: "Extintor sin mantenimiento.", opciones: ["Marcarlo", "Enviar a recarga", "Dejarlo"], correcta: 1 },
        { id: 47, nivel: 3, ambito: "Empresa", escenario: "Empleado fuma en zona prohibida.", opciones: ["Sancionar y corregir", "Advertir informalmente", "Ignorar"], correcta: 0 },
        { id: 48, nivel: 3, ambito: "Empresa", escenario: "Falta iluminaci√≥n de emergencia.", opciones: ["Instalarla", "Usar linternas", "No es necesaria"], correcta: 0 },
        { id: 49, nivel: 3, ambito: "Empresa", escenario: "Simulacros no realizados.", opciones: ["Esperar inspecci√≥n", "Ignorarlo", "Programarlos"], correcta: 2 },
        { id: 50, nivel: 3, ambito: "Empresa", escenario: "Dep√≥sito sobrecargado.", opciones: ["Cerrar puertas", "Ordenar y reducir carga", "Continuar"], correcta: 1 },
        { id: 51, nivel: 3, ambito: "Empresa", escenario: "Alarma contra incendios desactivada.", opciones: ["Reactivar de inmediato", "Usar silbato", "Avisar verbalmente"], correcta: 0 },
        { id: 52, nivel: 3, ambito: "Empresa", escenario: "Empleado intenta apagar un gran fuego sin capacitaci√≥n.", opciones: ["Dejarlo actuar", "Ayudar a apagarlo", "Ordenar evacuaci√≥n"], correcta: 2 },
        { id: 53, nivel: 3, ambito: "Empresa", escenario: "Plan de emergencia desactualizado.", opciones: ["Usar el viejo", "Solicitar Actualizaci√≥n", "Ignorarlo"], correcta: 1 },
        { id: 54, nivel: 3, ambito: "Empresa", escenario: "Reconozco trabajo con Materiales Peligrosos.", opciones: ["Solicitar capacitaci√≥n", "NUnca paso nada", "Pedir otro lugar de trabajo"], correcta: 0 },
        { id: 55, nivel: 3, ambito: "Empresa", escenario: "Fuga de gas detectada.", opciones: ["Ventilar solamente", "Continuar tareas", "Evacuar y cortar suministro"], correcta: 2 },
        { id: 56, nivel: 3, ambito: "Empresa", escenario: "Se√±alizaci√≥n inexistente.", opciones: ["Dar indicaciones orales", "Pedir colocar se√±al√©tica", "No es prioritaria"], correcta: 1 },
        { id: 57, nivel: 3, ambito: "Empresa", escenario: "Empleado bloquea salida con mercader√≠a.", opciones: ["Retirarla de inmediato", "Esperar inspecci√≥n", "Usar otra salida"], correcta: 0 },
        { id: 58, nivel: 3, ambito: "Empresa", escenario: "No hay responsable de seguridad designado.", opciones: ["Repartir tareas en la emergencia", "No es obligatorio", "Siempre asignar uno"], correcta: 2 },
        { id: 59, nivel: 3, ambito: "Empresa", escenario: "Cables sueltos en oficina.", opciones: ["Ordenarlos y repararlos", "Pisarlos con cuidado", "Ignorarlos"], correcta: 0 },
        { id: 60, nivel: 3, ambito: "Empresa", escenario: "No hay capacitaci√≥n en incendios.", opciones: ["Confiar en la experiencia", "Implementar capacitaci√≥n", "Esperar emergencia"], correcta: 1 },

        // NIVEL 4 - RESCATE VEHICULAR (ENFOQUE CIUDADANO)
{ id: 61, nivel: 4, ambito: "Rescate Vehicular", escenario: "Presencias un choque en cadena en la ruta. ¬øC√≥mo debes posicionar tu propio auto?", opciones: ["A un lado de los chocados para mirar", "Antes del accidente, en la banquina y con balizas", "En el medio de la calzada para frenar el tr√°nsito"], correcta: 1 },
{ id: 62, nivel: 4, ambito: "Rescate Vehicular", escenario: "Te acercas a un auto accidentado. Hay una persona consciente atrapada. ¬øQu√© es lo primero que le pides?", opciones: ["Que intente salir por la ventana", "Que mantenga la calma y no mueva el cuello ni la espalda", "Que busque sus documentos"], correcta: 1 },
{ id: 63, nivel: 4, ambito: "Rescate Vehicular", escenario: "Ves humo saliendo del motor de un auto chocado. No tienes extintor. ¬øQu√© haces?", opciones: ["Echarle arena o tierra", "Abrir el capot para ver de d√≥nde viene", "Alejar a la gente y esperar a bomberos"], correcta: 2 },
{ id: 64, nivel: 4, ambito: "Rescate Vehicular", escenario: "Una persona herida te pide agua desesperadamente tras el impacto. ¬øQu√© haces?", opciones: ["Le das un poco de agua fr√≠a", "No le das nada de beber ni comer", "Le das una bebida energ√©tica"], correcta: 1 },
{ id: 65, nivel: 4, ambito: "Rescate Vehicular", escenario: "Llamas al n√∫mero de emergencias. ¬øQu√© informaci√≥n es la m√°s vital?", opciones: ["Ubicaci√≥n exacta y cantidad de heridos", "Tu nombre y apellido", "El color de los autos chocados"], correcta: 0 },
{ id: 66, nivel: 4, ambito: "Rescate Vehicular", escenario: "Un herido est√° en el suelo y no respira bien. Alguien sugiere levantarlo para llevarlo en un auto particular.", opciones: ["Ayudar a levantarlo", "Impedir que lo muevan (riesgo de lesi√≥n medular)", "Llevarlo r√°pido al hospital m√°s cercano"], correcta: 1 },
{ id: 67, nivel: 4, ambito: "Rescate Vehicular", escenario: "Ves que una v√≠ctima lleva casco (motociclista) y parece tener dificultad para respirar.", opciones: ["Quitarle el casco inmediatamente", "Aflojarle la ropa sin mover la cabeza", "No quitarle el casco bajo ninguna circunstancia"], correcta: 2 },
{ id: 68, nivel: 4, ambito: "Rescate Vehicular", escenario: "Circulas por la ruta y ves balizas azules y rojas a lo lejos. ¬øQu√© debes hacer?", opciones: ["Disminuir la velocidad y estar atento a indicaciones", "Frenar para sacar una foto", "Tocar bocina para pasar r√°pido"], correcta: 0 },
{ id: 69, nivel: 4, ambito: "Rescate Vehicular", escenario: "Un auto chocado tiene el motor encendido pero el conductor est√° inconsciente. ¬øQu√© haces?", opciones: ["Intentar apagarlo desde afuera si es seguro", "Golpear el motor", "Esperar a que se acabe la nafta"], correcta: 0 },
{ id: 70, nivel: 4, ambito: "Rescate Vehicular", escenario: "De noche en la ruta, ¬øc√≥mo se√±alizas un accidente si no tienes balizas triangulares?", opciones: ["Caminando por la ruta hacia los autos que vienen", "Encendiendo las luces de tu auto apuntando al accidente", "Con la linterna del celular haciendo se√±as"], correcta: 2 },

  // NIVEL 5 - MATERIALES PELIGROSOS (MATPEL - NIVEL INICIAL)
{ id: 71, nivel: 5, ambito: "MatPel", escenario: "Encuentras un bid√≥n sin etiqueta en el garaje. ¬øQu√© es lo m√°s seguro?", opciones: ["Olerlo para identificarlo", "Tocarlo para ver si es viscoso", "Tratarlo como t√≥xico y no abrirlo"], correcta: 2 },
{ id: 72, nivel: 5, ambito: "MatPel", escenario: "¬øCu√°l es la principal forma en que un qu√≠mico t√≥xico entra al cuerpo en un ambiente cerrado?", opciones: ["Por la piel √∫nicamente", "Por la respiraci√≥n (inhalaci√≥n)", "Por los ojos"], correcta: 1 },
{ id: 73, nivel: 5, ambito: "MatPel", escenario: "Mezclas lavandina con detergente o amon√≠aco para limpiar mejor. ¬øQu√© sucede?", opciones: ["Se crea un gas t√≥xico que puede quemar tus pulmones", "La limpieza es m√°s efectiva", "No pasa nada, son compatibles"], correcta: 0 },
{ id: 74, nivel: 5, ambito: "MatPel", escenario: "Ves un cami√≥n volcado que tiene un cartel naranja con n√∫meros. ¬øQu√© haces?", opciones: ["Acercarte a ayudar al chofer", "Alejarte a mucha distancia y llamar a emergencias", "Sacar fotos de cerca para el seguro"], correcta: 1 },
{ id: 75, nivel: 5, ambito: "MatPel", escenario: "Te cae un l√≠quido qu√≠mico desconocido en el brazo. ¬øCu√°l es la acci√≥n inmediata?", opciones: ["Ponerse crema humectante", "Lavar con abundante agua corriente por 20 minutos", "Limpiar con un trapo seco"], correcta: 1 },
{ id: 76, nivel: 5, ambito: "MatPel", escenario: "Hay un derrame de un l√≠quido con olor fuerte en el supermercado. ¬øHacia d√≥nde evac√∫as?", opciones: ["Hacia donde sople el viento (viento a favor)", "En contra de la direcci√≥n del viento (viento de espalda)", "No importa la direcci√≥n"], correcta: 1 },
{ id: 77, nivel: 5, ambito: "MatPel", escenario: "Un producto tiene el s√≠mbolo de una calavera. ¬øQu√© significa?", opciones: ["Que es inflamable", "Que es altamente t√≥xico o mortal", "Que es corrosivo"], correcta: 1 },
{ id: 78, nivel: 5, ambito: "MatPel", escenario: "Sientes mareos y olor a 'huevo podrido' cerca de un desag√ºe o industria.", opciones: ["Es gas natural, no es peligroso", "Podr√≠a ser √°cido sulfh√≠drico, corre a un lugar ventilado", "Busca de d√≥nde viene el olor"], correcta: 1 },
{ id: 79, nivel: 5, ambito: "MatPel", escenario: "Encuentras una bater√≠a de auto hinchada o perdiendo l√≠quido.", opciones: ["Es solo agua, no pasa nada", "Es √°cido sulf√∫rico; puede quemar piel y ropa", "Limpiarla con la mano"], correcta: 1 },
{ id: 80, nivel: 5, ambito: "MatPel", escenario: "Ves un diamante de colores (Azul, Rojo, Amarillo, Blanco) en un tanque. ¬øQu√© indica el color Azul?", opciones: ["Riesgo de Incendio", "Riesgo a la Salud", "Reactividad"], correcta: 1 }
];
  
// --- VARIABLES DE ESTADO ---
let nivelActual = parseInt(localStorage.getItem('nivelGuardado')) || 1;
let puntosNivelActual = parseInt(localStorage.getItem('puntosNivelGuardado')) || 0;
let indiceEnNivel = parseInt(localStorage.getItem('indiceGuardado')) || 0;
let puntos = parseInt(localStorage.getItem('puntosTotales')) || 0; 
let vidas = 3;
let tiempoRestante;
let timerInterval;

const metasNivel = { 1: 2000, 2: 2000, 3: 2000, 4: 1000, 5: 1000 };

let ambitosCompletadosHoy = JSON.parse(localStorage.getItem('ambitosCompletados')) || {
    1: false, 2: false, 3: false, 4: false, 5: false
};

let usuarioNombre = localStorage.getItem('guardianNombre') || "";
let usuarioOrganizacion = localStorage.getItem('guardianOrg') || "";
let totalCompletados = parseInt(localStorage.getItem('totalEscenariosSuperados')) || 0;

// --- AUDIOS ---
const sonidoFuego = new Audio('https://actions.google.com/sounds/v1/ambiences/fire.ogg');
sonidoFuego.loop = true;
sonidoFuego.volume = 0.3;
const sonidoError = new Audio('https://actions.google.com/sounds/v1/impacts/crash_shatter.ogg');
const sonidoAcierto = new Audio('https://actions.google.com/sounds/v1/cartoon/clime_up_the_ladder.ogg');
const sonidoAlarma = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

// --- INICIO DE APP ---
window.onload = () => {
    verificarBloqueo();
    mostrarConsejoAlEntrar();
    
    if (usuarioNombre) {
        document.getElementById('modal-registro').style.display = 'none';
        actualizarInterfaz(); // Sincroniza barra y puntos al cargar
        
        // Si ya super√≥ el rango b√°sico, activar visualmente la IA
        if (totalCompletados >= 80) {
            prepararModoIAVisual();
        }
    }
};

function guardarIdentidad() {
    const nombre = document.getElementById('nombre-usuario').value;
    const org = document.getElementById('organizacion-usuario').value;
    if (nombre.trim().length < 3) {
        alert("Por favor, ingresa tu nombre para poder emitir tus certificados.");
        return;
    }
    usuarioNombre = nombre;
    usuarioOrganizacion = org || "Particular";
    localStorage.setItem('guardianNombre', usuarioNombre);
    localStorage.setItem('guardianOrg', usuarioOrganizacion);
    document.getElementById('modal-registro').style.display = 'none';
}

function guardarProgresoLocal() {
    localStorage.setItem('nivelGuardado', nivelActual);
    localStorage.setItem('puntosNivelGuardado', puntosNivelActual);
    localStorage.setItem('puntosTotales', puntos);
    localStorage.setItem('ambitosCompletados', JSON.stringify(ambitosCompletadosHoy));
    localStorage.setItem('totalEscenariosSuperados', totalCompletados);
    localStorage.setItem(`indiceNivel_${nivelActual}`, indiceEnNivel);
}

// --- TEMPORIZADOR ---
function iniciarTemporizador() { 
    clearInterval(timerInterval);
    document.getElementById("timer-display").innerText = `‚è±Ô∏è ${tiempoRestante}s`;
    
    timerInterval = setInterval(() => {
        tiempoRestante--;
        document.getElementById("timer-display").innerText = `‚è±Ô∏è ${tiempoRestante}s`;
        if (tiempoRestante <= 5 && tiempoRestante > 0) sonidoAlarma.play();
        if (tiempoRestante <= 0) {
            clearInterval(timerInterval);
            manejarError("¬°TIEMPO AGOTADO!");
        }
    }, 1000);
}

// --- FLUJO DE ESCENARIOS ---
function seleccionarAmbito(num) {
    if (ambitosCompletadosHoy[num] && totalCompletados < 80) {
        alert("Este sector ya est√° asegurado. ¬°Prueba con otro!");
        return;
    }
    
    nivelActual = num;
    indiceEnNivel = parseInt(localStorage.getItem(`indiceNivel_${nivelActual}`)) || 0;
    puntosNivelActual = indiceEnNivel * 100;

    document.getElementById("txt-nivel").innerText = `Nivel ${num}: ${obtenerNombreAmbito(num)}`;
    document.getElementById('selector-niveles').style.display = "none";
    document.getElementById("simulador").style.display = "block";

    cargarEscenario();
}

async function cargarEscenario() {
    if (vidas <= 0) return;

    // Si ya completamos el cupo de preguntas manuales de este nivel o somos nivel experto
    let metaPreguntas = metasNivel[nivelActual] / 100;
    const escenariosManuales = typeof baseDeDatosEscenarios !== 'undefined' 
        ? baseDeDatosEscenarios.filter(e => e.nivel === nivelActual) 
        : [];

    if (indiceEnNivel >= escenariosManuales.length || totalCompletados >= 80) {
        generarEscenarioIA(); 
    } else {
        renderizarEscenario(escenariosManuales[indiceEnNivel]);
    }
}

function renderizarEscenario(objetoEscenario) {
    const scenarioQuestion = document.getElementById("scenario-question");
    const optionsContainer = document.getElementById("options-container"); // <-- ASEG√öRATE DE QUE ESTA L√çNEA EST√â
    const feedback = document.getElementById("feedback");
    const btnSiguiente = document.getElementById("btn-siguiente");

    if (!optionsContainer) {
        console.error("No se encontr√≥ el elemento options-container en el HTML");
        return;
    }

    feedback.style.display = "none";
    btnSiguiente.style.display = "none";
    scenarioQuestion.innerText = objetoEscenario.escenario;
    optionsContainer.innerHTML = "";

    objetoEscenario.opciones.forEach((opcion, index) => {
        const btn = document.createElement("button");
        btn.classList.add("btn-opcion");
        btn.innerText = opcion;
        btn.onclick = () => verificarRespuesta(index, objetoEscenario);
        optionsContainer.appendChild(btn);
    });

    // Agregar bot√≥n de salida si es modo IA (total >= 80)
    if (totalCompletados >= 80) {
        const btnSalir = document.createElement("p");
        btnSalir.innerHTML = "<br><span style='cursor:pointer; color:#888; text-decoration:underline; font-size:0.9em;'>‚á† Volver a sectores</span>";
        btnSalir.onclick = volverAlMenu;
        optionsContainer.appendChild(btnSalir);
    }

    tiempoRestante = totalCompletados >= 80 ? 45 : 30;
    iniciarTemporizador();
}

async function verificarRespuesta(indexElegido, objetoEscenario) {
    clearInterval(timerInterval);
    const feedback = document.getElementById("feedback");
    const btnSiguiente = document.getElementById("btn-siguiente");
    const botones = document.querySelectorAll(".btn-opcion");
    
    botones.forEach(b => b.disabled = true);
    feedback.style.display = "block";

    // --- CAMINO A: RESPUESTA CORRECTA ---
    if (indexElegido === objetoEscenario.correcta) {
        sonidoAcierto.play();
        indiceEnNivel++;
        puntos += 100;
        
        localStorage.setItem(`indiceNivel_${nivelActual}`, indiceEnNivel);
        feedback.innerHTML = `<div style="color: #2e7d32; font-weight: bold; margin-bottom: 10px;">‚úÖ ¬°CORRECTO! +100 puntos.</div>`;
        actualizarInterfaz();

        const limites = { 1: 20, 2: 20, 3: 20, 4: 10, 5: 10 };

        if (totalCompletados >= 80) {
            btnSiguiente.style.display = "block";
            btnSiguiente.innerText = "SIGUIENTE DESAF√çO IA ü§ñ";
            btnSiguiente.onclick = siguientePregunta;
        } 
        else if (indiceEnNivel >= limites[nivelActual]) {
            ambitosCompletadosHoy[nivelActual] = true;
            localStorage.setItem('ambitosCompletados', JSON.stringify(ambitosCompletadosHoy));
            feedback.innerHTML += `
                <div style="background: #e8f5e9; padding: 15px; border: 2px solid #2e7d32; border-radius: 10px; margin-top: 10px;">
                    <h3 style="color: #2e7d32; margin: 0;">üèÜ ¬°NIVEL ASEGURADO!</h3>
                    <button class="main-btn" onclick="volverAlMenu()">VOLVER AL MEN√ö</button>
                </div>`;
            btnSiguiente.style.display = "none";
        } 
        else {
            btnSiguiente.style.display = "block";
            btnSiguiente.innerText = "SIGUIENTE ESCENARIO ‚ûî";
            btnSiguiente.onclick = siguientePregunta;
        }
    } 
    // --- CAMINO B: RESPUESTA INCORRECTA ---
    else {
        sonidoError.play();
        manejarError("Incorrecto"); // Aqu√≠ resta vidas y actualiza UI
        
        feedback.innerHTML = `<div style="color: #d32f2f; font-weight: bold; margin-bottom: 10px;">‚ùå ACCI√ìN INSEGURA</div>`;
        feedback.innerHTML += `<div id="explicacion-ia" style="font-style: italic; color: #555; background: #ffeeee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                    üïµÔ∏è Analizando riesgos de tu decisi√≥n...
                               </div>`;

        fetch('https://guardiandeemergencias.pythonanywhere.com/analizar_error', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                error: objetoEscenario.opciones[indexElegido],
                escenario: objetoEscenario.escenario 
            })
        })
        .then(res => res.json())
        .then(data => {
            const expBox = document.getElementById("explicacion-ia");
            if(expBox) expBox.innerText = `‚ö†Ô∏è Peligro: ${data.consejo}`;
        })
        .catch(() => {
            const expBox = document.getElementById("explicacion-ia");
            if(expBox) expBox.innerText = "‚ö†Ô∏è Esa acci√≥n pone en riesgo la integridad del equipo y las v√≠ctimas.";
        });

        btnSiguiente.style.display = "block";
        btnSiguiente.innerText = totalCompletados >= 80 ? "REINTENTAR DESAF√çO IA" : "CONTINUAR ENTRENAMIENTO";
        btnSiguiente.onclick = siguientePregunta;
    }
}

async function generarEscenarioIA() {
    const scenarioQuestion = document.getElementById("scenario-question");
    const optionsContainer = document.getElementById("options-container");
    
    scenarioQuestion.innerText = "üì° Conectando con el Centro de Comando IA...";
    optionsContainer.innerHTML = `
        <div style="text-align:center;">
            <div class="spinner"></div>
            <p id="loading-msg">Generando escenario t√°ctico...</p>
        </div>`;

    // Cambiar mensajes cada 3 segundos para que el usuario no se aburra
    let mensajes = ["Analizando variables...", "Calculando riesgos...", "Sincronizando simulador..."];
    let i = 0;
    let intervaloMsg = setInterval(() => {
        const msgElement = document.getElementById("loading-msg");
        if(msgElement) msgElement.innerText = mensajes[i % mensajes.length];
        i++;
    }, 3000);

    try {
        const response = await fetch('https://guardiandeemergencias.pythonanywhere.com/generar_escenario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nivel: nivelActual })
        });

        if (!response.ok) {
            // Esto nos dir√° si el error es del servidor (500, 404, etc.)
            throw new Error(`Error del servidor: ${response.status}`);
        }

        const data = await response.json();

        if (!data || !data.opciones) {
            throw new Error("Respuesta de IA malformada");
        }

        let correctaTexto = data.opciones[data.correcta];
        data.opciones.sort(() => Math.random() - 0.5);
        data.correcta = data.opciones.indexOf(correctaTexto);

        renderizarEscenario(data);
    } catch (error) {
        console.error("Detalle del error:", error);
        scenarioQuestion.innerText = "‚ùå Fallo en la red de comando.";
        optionsContainer.innerHTML = `
            <p style="color:red;">${error.message}</p>
            <button class="main-btn" onclick="generarEscenarioIA()">REINTENTAR CONEXI√ìN</button>
            <button class="main-btn" style="background:#666;" onclick="volverAlMenu()">VOLVER AL MEN√ö</button>
        `;
    }
}

// 1. CORRECCI√ìN DEL CONTADOR (Evita el error NaN)
function actualizarInterfaz() {
    let n1 = parseInt(localStorage.getItem('indiceNivel_1')) || 0;
    let n2 = parseInt(localStorage.getItem('indiceNivel_2')) || 0;
    let n3 = parseInt(localStorage.getItem('indiceNivel_3')) || 0;
    let n4 = parseInt(localStorage.getItem('indiceNivel_4')) || 0;
    let n5 = parseInt(localStorage.getItem('indiceNivel_5')) || 0;
    
    totalCompletados = n1 + n2 + n3 + n4 + n5;
    localStorage.setItem('totalEscenariosSuperados', totalCompletados);

    document.getElementById("txt-puntos").innerText = puntos;
    
    const progresoBarra = Math.min((totalCompletados / 80) * 100, 100);
    const fill = document.getElementById("bar-fill");
    if(fill) fill.style.width = progresoBarra + "%";

    // --- CAMBIO AQU√ç: Solo mostrar diploma exactamente a los 80 ---
    // Si ya tiene el diploma y sigue jugando (total > 80), no lo mostramos m√°s.
    if (totalCompletados === 80 && !localStorage.getItem('diplomaEntregado')) {
        localStorage.setItem('diplomaEntregado', 'true');
        mostrarDiplomaFinal();
    }
}

// 2. CORRECCI√ìN DEL DIPLOMA (Forzar visibilidad)
function mostrarDiplomaFinal() {
    console.log("üèÜ ¬°Meta alcanzada! Mostrando certificaci√≥n.");
    
    // Ocultar todo lo dem√°s
    document.getElementById("simulador").style.display = "none";
    document.getElementById("selector-niveles").style.display = "none";
    
    // Mostrar diploma y bot√≥n IA con prioridad alta
    const cert = document.getElementById("pantalla-certificado");
    const btnIA = document.getElementById("contenedor-boton-ia");
    
    cert.style.setProperty("display", "block", "important");
    btnIA.style.setProperty("display", "block", "important");

    // Llenar datos
    document.getElementById("diploma-nombre").innerText = usuarioNombre.toUpperCase();
    document.getElementById("diploma-org").innerText = usuarioOrganizacion.toUpperCase();
    
    const f = new Date();
    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    document.getElementById("diploma-fecha").innerText = `${f.getDate()} de ${meses[f.getMonth()]} de ${f.getFullYear()}`;
    
    sonidoAcierto.play();
}

function continuarEntrenamientoIA() {
    document.getElementById("pantalla-certificado").style.display = "none";
    document.getElementById("contenedor-boton-ia").style.display = "none";
    document.getElementById("selector-niveles").style.display = "block";
    prepararModoIAVisual();
    alert("üë®‚Äçüöí MODO IA ACTIVADO: Los escenarios ahora son din√°micos e infinitos.");
}

function prepararModoIAVisual() {
    const botones = document.querySelectorAll('.info-card .main-btn');
    botones.forEach(btn => {
        btn.style.background = "#2196F3";
        btn.innerText = "DESAF√çO IA ü§ñ";
        btn.disabled = false;
    });
}

function volverAlMenu() {
    clearInterval(timerInterval);
    document.getElementById("simulador").style.display = "none";
    document.getElementById("selector-niveles").style.display = "block";
    if (totalCompletados >= 80) prepararModoIAVisual();
}

function siguientePregunta() {
    cargarEscenario();
}

function manejarError(msg) {
    vidas--;
    actualizarVidasUI();
    if (vidas <= 0) {
        const manana = new Date().getTime() + (24 * 60 * 60 * 1000);
        localStorage.setItem('bloqueoEntrenamiento', manana);
        bloquearApp("‚ö†Ô∏è Demasiados fallos cr√≠ticos. Regresa ma√±ana para reentrenar.");
    }
}

function actualizarVidasUI() {
    const display = document.getElementById("vidas-display");
    if(display) display.innerText = "‚ù§Ô∏è".repeat(Math.max(0, vidas)) + "üñ§".repeat(Math.max(0, 3 - vidas));
}

function obtenerNombreAmbito(num) {
    return ["", "Hogar", "Escuela", "Empresa", "Rescate Vehicular", "MatPel"][num];
}

async function mostrarConsejoAlEntrar() {
    const textoBox = document.getElementById('texto-consejo-ia');
    // Ponemos un mensaje de carga moment√°neo
    textoBox.innerText = "Recibiendo instrucciones del comando...";

    try {
        const res = await fetch('https://guardiandeemergencias.pythonanywhere.com/consejo_diario');
        if (!res.ok) throw new Error("Error en servidor");
        
        const data = await res.json();
        
        if (data && data.consejo) {
            textoBox.innerText = `"${data.consejo}"`;
        } else {
            textoBox.innerText = "La seguridad es una decisi√≥n diaria.";
        }
    } catch (e) {
        console.log("Usando respaldo por delay de red.");
        textoBox.innerText = "La seguridad es una decisi√≥n diaria.";
    }
}

function cerrarConsejoYMostrarInicio() {
    document.getElementById('modal-nuevo-diseno').style.display = 'none';
    document.getElementById('pantalla-inicio').style.display = 'flex';
}

function iniciarSimulacro() {
    sonidoFuego.play().catch(() => {});
    document.getElementById('pantalla-inicio').style.display = 'none';
    document.getElementById('selector-niveles').style.display = 'block';
}

function verificarBloqueo() {
    const bloqueo = localStorage.getItem('bloqueoEntrenamiento');
    if (bloqueo && new Date().getTime() < bloqueo) {
        bloquearApp("üö® Guardia suspendida por hoy. Prioriza el estudio de protocolos.");
    }
}

function bloquearApp(msg) {
    document.body.innerHTML = `<div style="height:100vh; background:#111; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; font-family:sans-serif;">
        <h1>üë®‚Äçüöí ACADEMIA DE BOMBEROS</h1><p style="font-size:1.5rem;">${msg}</p></div>`;
}
</script>

<div id="banner-comercial" style="background: linear-gradient(90deg, #1a1a1a, #2c3e50); border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; margin: 30px auto; max-width: 600px; text-align: center; color: white; font-family: sans-serif;">
    <h3 style="margin-top: 0; color: #e74c3c;">üöÄ ¬øQuer√©s llevar este simulador a tu Empresa o Escuela?</h3>
    <p style="font-size: 0.95em; line-height: 1.4;">Estamos desarrollando m√≥dulos avanzados de <b>Accidentes Viales</b> y <b>Materiales Peligrosos</b>.</p>
    
    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
        <a href="https://forms.gle/S7gkFJ77V3cLCWWz9" target="_blank" style="background-color: #e74c3c; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; transition: 0.3s;">Me interesa para mi Instituci√≥n</a>
        
        <a href="https://cafecito.app/emergencyguardian26" target="_blank" style="background-color: #2ecc71; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; transition: 0.3s;">‚òï Apoyar el Proyecto</a>
    </div>
</div>

<footer style="text-align: center; padding: 20px; color: #888; font-size: 0.9em; border-top: 1px solid #333; margin-top: 50px;">
        <p>&copy; 2025 - 2026 **Guardi√°n de Emergencias**. Todos los derechos reservados.</p>
        <p style="font-size: 0.8em;">Prohibida la reproducci√≥n total o parcial de este software, su l√≥gica de simulaci√≥n y contenido educativo sin autorizaci√≥n expresa del autor.</p>
        <p style="font-size: 0.7em; color: #555;">Desarrollado con Inteligencia Artificial aplicada a la Seguridad Civil.</p>
    </footer>
</body>
</html>