<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Guardi√°n de Emergencias - Prevenci√≥n</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f4f4f9; color: #333; }
        header { background: #d32f2f; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { color: #d32f2f; margin-top: 0; }
        
        .simulator { border-top: 5px solid #d32f2f; }
        .btn-opcion { background: #f8f9fa; color: #333; border: 1px solid #ddd; padding: 12px; margin: 8px 0; display: block; width: 100%; text-align: left; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-opcion:hover { background: #e9ecef; border-color: #d32f2f; }
        
        .info-card { border-top: 5px solid #2196F3; }
        .info-card ul { text-align: left; padding-left: 20px; }

        .stats { background: #333; color: white; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .progress-bar { background: #555; border-radius: 10px; height: 15px; width: 100%; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: #4caf50; height: 100%; width: 0%; transition: width 0.5s; }
        
        #feedback { font-weight: bold; margin-top: 15px; padding: 15px; border-radius: 5px; display: none; }
        button.main-btn { background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .vidas-container { font-size: 24px; color: #ff5252; }
        #timer-display { font-weight: bold; color: #ffeb3b; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>
    
<header>
        <h1>Guardi√°n de Emergenciasüî•</h1>
     <div id="pantalla-inicio" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column;">
     <h1 style="color: white; margin-bottom: 20px;">Simulador de Incendios</h1>
     <button id="btn-comenzar" onclick="iniciarSimulacro()" style="padding: 15px 30px; font-size: 20px; cursor: pointer; background: #e63946; color: white; border: none; border-radius: 5px;">
        COMENZAR SIMULACRO
     </button>
    </div>

    <div>
        <span id="txt-nivel">Nivel 1: Hogar</span> | 
        <span id="vidas-display" class="vidas-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span> |
        <span id="timer-display">‚è±Ô∏è 30s</span> |
        <strong>Puntos: <span id="txt-puntos">0</span></strong>
    </div>
</header>

<div class="container">
    <div class="card simulator" id="simulador">
        <h3 id="scenario-title">üî• Simulacro Interactivo</h3>
        <p id="scenario-question" style="font-size: 18px; font-weight: bold;">Cargando escenario...</p>
        <div id="options-container"></div>
        <div id="feedback"></div>
    </div>

    <div class="grid">
        <div class="card info-card">
            <h3>üè† Hogar</h3>
            <ul>
                <li>Instala detectores de humo.</li>
                <li>No dejes velas solas.</li>
            </ul>
            <button class="main-btn" onclick="seleccionarAmbito(1)">Jugar Nivel Hogar</button>
        </div>
        <div class="card info-card" style="border-top-color: #4caf50;">
            <h3>üè´ Escuela</h3>
            <ul>
                <li>Conoce las rutas de evacuaci√≥n.</li>
                <li>Informa cables pelados.</li>
            </ul>
            <button class="main-btn" onclick="seleccionarAmbito(2)">Jugar Nivel Escuela</button>
        </div>
        <div class="card info-card" style="border-top-color: #ff5722;">
            <h3>üè¢ Empresa</h3>
            <ul>
                <li>Mant√©n extintores despejados.</li>
                <li>No sobrecargues enchufes.</li>
            </ul>
            <button class="main-btn" onclick="seleccionarAmbito(3)">Jugar Nivel Empresa</button>
        </div>
    </div>

    <div class="stats">
        <h4>Tu Progreso Global</h4>
        <div class="progress-bar"><div class="progress-fill" id="bar-fill"></div></div>
        <p id="progress-text">¬°Completa escenarios para subir de rango!</p>
    </div>

    <div id="pantalla-certificado" style="display:none; text-align:center; padding:50px; border:10px double #d32f2f; background:white; margin-top:20px; border-radius: 15px;">
        <h1 style="color:#d32f2f;">üìú DIPLOMA DE HONOR</h1>
        <p style="font-size:20px;">Se certifica que:</p>
        <h2 id="diploma-nombre" style="background: #ffeb3b; display: inline-block; padding: 10px; min-width: 200px;">CADETE</h2>
        <p style="font-size:20px;">ha completado con √©xito el entrenamiento de prevenci√≥n.</p>
        <p>Otorgado el: <strong id="diploma-fecha">--/--/----</strong></p>
       <br>
       <button class="main-btn" onclick="window.print()">üñ®Ô∏è Imprimir Diploma</button>
       <button class="main-btn" style="background:#2196F3;" onclick="continuarEntrenamiento()">üöÄ Seguir con otro √Åmbito</button>
    </div>
    <style>
    #modal-nuevo-diseno {
        display: flex; 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 99999 !important; /* Prioridad m√°xima */
        align-items: center; 
        justify-content: center; 
        backdrop-filter: blur(10px);
    }
    .modal-contenido-fire {
        background: white; 
        padding: 40px; 
        border-radius: 30px; 
        max-width: 400px; 
        text-align: center; 
        border: 8px solid #d32f2f; 
        position: relative; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    .casco-container {
        position: absolute; 
        top: -55px; left: 50%; 
        transform: translateX(-50%); 
        background: #d32f2f; 
        width: 90px; height: 90px; 
        border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 45px; border: 6px solid white;
    }
</style>

<div id="modal-nuevo-diseno">
    <div class="modal-contenido-fire">
        <div class="casco-container">üë®‚Äçüöí</div>
        <h2 style="color:#d32f2f; margin-top:25px; font-family: sans-serif; font-weight: 900;">üö® LECCI√ìN DEL D√çA</h2>
        <hr style="border: 0; border-top: 2px solid #eee; margin: 15px 0;">
        <p id="texto-consejo-ia" style="font-size: 1.2rem; color: #333; line-height: 1.6; font-style: italic;">
            Cargando sabidur√≠a...
        </p>
        <button class="main-btn" onclick="document.getElementById('modal-nuevo-diseno').style.display='none'; document.querySelector('.container').style.display='block';" 
                style="background: #d32f2f; color: white; border: none; padding: 12px 35px; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 15px;">
            ¬°ENTENDIDO, CAPIT√ÅN!
        </button>
    </div>
</div>

<script>
    // BASE DE DATOS COMPLETA
    const baseDeDatosEscenarios = [
        // NIVEL 1 - HOGAR
       { id: 1, nivel: 1, ambito: "Hogar", escenario: "Se produce un peque√±o incendio en una sart√©n con aceite.", opciones: ["Echar agua inmediatamente", "Tapar la sart√©n y apagar el fuego", "Mover la sart√©n al patio"], correcta: 1 },
       { id: 2, nivel: 1, ambito: "Hogar", escenario: "Un enchufe comienza a largar chispas.", opciones: ["Cortar la corriente y desenchufar", "Echarle agua", "Cubrirlo con una tela"], correcta: 0 },
       { id: 3, nivel: 1, ambito: "Hogar", escenario: "Hay humo saliendo del horno el√©ctrico.", opciones: ["Abrir el horno inmediatamente", "Desenchufar y mantener cerrado", "Dejar que siga en funcionamiento"], correcta: 1 },
       { id: 4, nivel: 1, ambito: "Hogar", escenario: "Tienes que salir a realizar tr√°mites, regresas r√°pido y tiene hornallas encendidas.", opciones: ["Avisas a tu hijo que est√° con el celular", "Te vas y no avisas", "La apagas y enciendes al regresar"], correcta: 2 },
       { id: 5, nivel: 1, ambito: "Hogar", escenario: "Se genera un incendio en una habitaci√≥n.", opciones: ["Intento apagarlo", "Abro puertas y ventanas", "LLamo a bomberos e intento apagarlo"], correcta: 2 },
       { id: 6, nivel: 1, ambito: "Hogar", escenario: "Detect√°s olor a gas en la cocina.", opciones: ["Encender la luz", "Ventilar y cerrar la llave de gas", "Usar el celular"], correcta: 1 },
       { id: 7, nivel: 1, ambito: "Hogar", escenario: "Un calefactor est√° muy cerca de muebles.", opciones: ["Apagarlo y alejarlo", "Bajar la temperatura","Nada, es normal"], correcta: 0 },
       { id: 8, nivel: 1, ambito: "Hogar", escenario: "Un ni√±o juega con f√≥sforos.", opciones: ["Quitarlos y explicar el riesgo", "Dejarlo aprender", "Ignorar"], correcta: 0 },
       { id: 9, nivel: 1, ambito: "Hogar", escenario: "Se corta la luz y us√°s velas.", opciones: ["Colocarlas sobre un mesa de madera", "Ubicarlas dentro de un frasco", "Dejarlas y dormir"], correcta: 1 },
       { id: 10, nivel: 1, ambito: "Hogar", escenario: "Una estufa a gas no tiene ventilaci√≥n.", opciones: ["Apagarla y ventilar", "Usarla igual", "Usarla y ventilar"], correcta: 0 },
       { id: 11, nivel: 1, ambito: "Hogar", escenario: "Hay acumulaci√≥n de cables sobrecargados.", opciones: ["Distribuir la carga", "Usar una zapatilla m√°s", "Ignorarlo, es normal"], correcta: 0 },
       { id: 12, nivel: 1, ambito: "Hogar", escenario: "Un aerosol se calienta cerca del fuego.", opciones: ["Alejarlo del calor", "Pincharlo", "Dejarlo"], correcta: 0 },
       { id: 13, nivel: 1, ambito: "Hogar", escenario: "Una plancha queda enchufada.", opciones: ["Desenchufarla y dejarla en lugar seguro", "Desenchufarla y guardarla", "Dejarla enchufada"], correcta: 0 },
       { id: 14, nivel: 1, ambito: "Hogar", escenario: "Se prende fuego un papel.", opciones: ["Apagarlo r√°pidamente", "Dejarlo consumir", "Soplar"], correcta: 0 },
       { id: 15, nivel: 1, ambito: "Hogar", escenario: "Una salida est√° bloqueada.", opciones: ["Liberarla", "Recordarla", "Ignorar"], correcta: 0 },
       { id: 16, nivel: 1, ambito: "Hogar", escenario: "Una parrilla se usa dentro de la casa.", opciones: ["Apagarla y sacarla", "Abrir ventanas","Continuar sin hacer nada"], correcta: 0 },
       { id: 17, nivel: 1, ambito: "Hogar", escenario: "Un cargador se calienta demasiado.", opciones: ["Desenchufarlo", "Ponerlo bajo una almohada", "Seguir cargando"], correcta: 0 },
       { id: 18, nivel: 1, ambito: "Hogar", escenario: "Enciendo el lavarropas y me voy a trabajar.", opciones: ["Siempre lo hice, no pasa nada", "La conexi√≥n el√©ctrica est√° bien", "Apagar y lavar al regreso"], correcta: 0 },
       { id: 19, nivel: 1, ambito: "Hogar", escenario: "Una frazada toca una estufa.", opciones: ["Alejarla", "Mojarla", "Ignorar"], correcta: 0 },
       { id: 20, nivel: 1, ambito: "Hogar", escenario: "No hay matafuego en casa.", opciones: ["Adquirir uno", "Usar agua siempre", "No es necesario"], correcta: 0 },
        
        // NIVEL 2 - ESCUELA
        { id: 21, nivel: 2, ambito: "Escuela", escenario: "Se activa la alarma de incendio durante clase.", opciones: ["Salir ordenadamente", "Correr", "Esconderse"], correcta: 0 },
        { id: 22, nivel: 2, ambito: "Escuela", escenario: "Un alumno detecta humo en el pasillo.", opciones: ["Avisar inmediatamente a un adulto", "Abrir ventanas", "Ignorarlo"], correcta: 0 },
        { id: 23, nivel: 2, ambito: "Escuela", escenario: "Una salida de emergencia est√° bloqueada.", opciones: ["Informar a la direcci√≥n", "Intentar usarla igual", "Esperar una emergencia"], correcta: 0 },
        { id: 24, nivel: 2, ambito: "Escuela", escenario: "Un matafuego no est√° se√±alizado.", opciones: ["Solicitar se√±alizaci√≥n", "Moverlo de lugar", "Ignorarlo"], correcta: 0 },
        { id: 25, nivel: 2, ambito: "Escuela", escenario: "Durante un simulacro un alumno corre.", opciones: ["Indicarle que camine", "Seguirlo", "Gritarle"], correcta: 0},
        { id: 26, nivel: 2, ambito: "Escuela", escenario: "Se produce un principio de incendio en laboratorio.", opciones: ["Evacuar y avisar", "Intentar apagar sin capacitaci√≥n", "Cerrar el aula"], correcta: 0 },
        { id: 27, nivel: 2, ambito: "Escuela", escenario: "Cables el√©ctricos est√°n deteriorados.", opciones: ["Informar y no usarlos", "Usarlos con cuidado", "Cubrirlos con cinta"], correcta: 0},
        { id: 28, nivel: 2, ambito: "Escuela", escenario: "Un alumno juega con un encendedor.", opciones: ["Retirarlo y avisar", "Re√≠rse", "Ignorarlo"], correcta: 0 },
        { id: 29, nivel: 2, ambito: "Escuela", escenario: "Se corta la luz en horario escolar.", opciones: ["Mantener la calma", "Correr hacia la salida", "Salir solo del aula"], correcta: 0 },
        { id: 30, nivel: 2, ambito: "Escuela", escenario: "Un docente desconoce el plan de evacuaci√≥n.", opciones: ["Informar y Capacitarse", "Improvisar", "Ignorarlo"], correcta: 0 },
        { id: 31, nivel: 2, ambito: "Escuela", escenario: "Material inflamable mal almacenado.", opciones: ["Reubicarlo correctamente", "Alejar alumnos", "Dejarlo"], correcta: 0 },
        { id: 32, nivel: 2, ambito: "Escuela", escenario: "Un simulacro no se realiza hace a√±os.", opciones: ["Solicitar uno", "Esperar emergencia", "No es necesario"], correcta: 0 },
        { id: 33, nivel: 2, ambito: "Escuela", escenario: "Puertas de emergencia cerradas con llave.", opciones: ["Mantenerlas desbloqueadas", "Abrir solo en emergencia", "Ignorarlo"], correcta: 0 },
        { id: 34, nivel: 2, ambito: "Escuela", escenario: "Humo en el aula.", opciones: ["Evacuar inmediatamente de manera controlada", "Guardar los √∫tiles en mochilas", "Buscar origen sin avisar"], correcta: 0 },
        { id: 35, nivel: 2, ambito: "Escuela", escenario: "Extintor vencido.", opciones: ["Solicitar recarga", "Usarlo igual", "Quitar y guardarlo"], correcta: 0 },
        { id: 36, nivel: 2, ambito: "Escuela", escenario: "Escalera bloqueada con sillas.", opciones: ["Despejarla", "Pasar igual por el espacio que queda", "Dejarla"], correcta: 0 },
        { id: 37, nivel: 2, ambito: "Escuela", escenario: "Fuego en un tacho de basura.", opciones: ["Avisar y usar agua o extintor", "Patearlo", "Correr"], correcta: 0 },
        { id: 38, nivel: 2, ambito: "Escuela", escenario: "Alumnos empujan durante evacuaci√≥n.", opciones: ["Detener y ordenar", "Acelerar", "Ignorar"], correcta: 0 },
        { id: 39, nivel: 2, ambito: "Escuela", escenario: "No hay planos de evacuaci√≥n visibles.", opciones: ["Solicitar colocaci√≥n", "Explicarlo oralmente", "No es necesario"], correcta: 0 },
        { id: 40, nivel: 2, ambito: "Escuela", escenario: "Se produce un incendio y alarma no funciona.", opciones: ["Repararla", "Avisar a gritos", "Ir por Aulas y Oficinas avisando"], correcta: 0 },
       
        // NIVEL 3 - EMPRESA
        { id: 41, nivel: 3, ambito: "Empresa", escenario: "Se detecta humo en el √°rea de producci√≥n.", opciones: ["Activar alarma y evacuar", "Continuar trabajando", "Abrir ventanas"], correcta: 0 },
        { id: 42, nivel: 3, ambito: "Empresa", escenario: "Un empleado no conoce el plan de evacuaci√≥n.", opciones: ["Capacitarlo", "Ignorarlo", "Asignarle otra tarea"], correcta: 0 },
        { id: 43, nivel: 3, ambito: "Empresa", escenario: "Material inflamable mal rotulado.", opciones: ["Corregir rotulaci√≥n", "Tachar sin avisar", "Usarlo igual"], correcta: 0 },
        { id: 44, nivel: 3, ambito: "Empresa", escenario: "Salida de emergencia obstruida.", opciones: ["Liberarla", "Avisar despu√©s", "Usar otra"], correcta: 0 },
        { id: 45, nivel: 3, ambito: "Empresa", escenario: "Incendio el√©ctrico en tablero.", opciones: ["Cortar energ√≠a y usar extintor adecuado", "Echar agua", "Salir corriendo"], correcta: 0 },
        { id: 46, nivel: 3, ambito: "Empresa", escenario: "Extintor sin mantenimiento.", opciones: ["Enviar a recarga", "Marcarlo", "Dejarlo"], correcta: 0 },
        { id: 47, nivel: 3, ambito: "Empresa", escenario: "Empleado fuma en zona prohibida.", opciones: ["Sancionar y corregir", "Advertir informalmente", "Ignorar"], correcta: 0 },
        { id: 48, nivel: 3, ambito: "Empresa", escenario: "Falta iluminaci√≥n de emergencia.", opciones: ["Instalarla", "Usar linternas", "No es necesaria"], correcta: 0 },
        { id: 49, nivel: 3, ambito: "Empresa", escenario: "Simulacros no realizados.", opciones: ["Programarlos", "Esperar inspecci√≥n", "Ignorarlo"], correcta: 0 },
        { id: 50, nivel: 3, ambito: "Empresa", escenario: "Dep√≥sito sobrecargado.", opciones: ["Ordenar y reducir carga", "Cerrar puertas", "Continuar"], correcta: 0 },
        { id: 51, nivel: 3, ambito: "Empresa", escenario: "Alarma contra incendios desactivada.", opciones: ["Reactivar de inmediato", "Usar silbato", "Avisar verbalmente"], correcta: 0 },
        { id: 52, nivel: 3, ambito: "Empresa", escenario: "Empleado intenta apagar un gran fuego sin capacitaci√≥n.", opciones: ["Ordenar evacuaci√≥n", "Dejarlo actuar", "Ayudar a apagarlo"], correcta: 0 },
        { id: 53, nivel: 3, ambito: "Empresa", escenario: "Plan de emergencia desactualizado.", opciones: ["Actualizarlo", "Usar el viejo", "Ignorarlo"], correcta: 0 },
        { id: 54, nivel: 3, ambito: "Empresa", escenario: "Reconozco trabajo con Materiales Peligrosos.", opciones: ["Solicitar capacitaci√≥n", "NUnca paso nada", "Pedir otro lugar de trabajo"], correcta: 0 },
        { id: 55, nivel: 3, ambito: "Empresa", escenario: "Fuga de gas detectada.", opciones: ["Evacuar y cortar suministro", "Ventilar solamente", "Continuar tareas"], correcta: 0 },
        { id: 56, nivel: 3, ambito: "Empresa", escenario: "Se√±alizaci√≥n inexistente.", opciones: ["Pedir colocar se√±al√©tica", "Dar indicaciones orales", "No es prioritaria"], correcta: 0 },
        { id: 57, nivel: 3, ambito: "Empresa", escenario: "Empleado bloquea salida con mercader√≠a.", opciones: ["Retirarla de inmediato", "Esperar inspecci√≥n", "Usar otra salida"], correcta: 0 },
        { id: 58, nivel: 3, ambito: "Empresa", escenario: "No hay responsable de seguridad designado.", opciones: ["Asignar uno", "Repartir tareas", "No es obligatorio"], correcta: 0 },
        { id: 59, nivel: 3, ambito: "Empresa", escenario: "Cables sueltos en oficina.", opciones: ["Ordenarlos y repararlos", "Pisarlos con cuidado", "Ignorarlos"], correcta: 0 },
        { id: 60, nivel: 3, ambito: "Empresa", escenario: "No hay capacitaci√≥n en incendios.", opciones: ["Implementar capacitaci√≥n", "Confiar en experiencia", "Esperar emergencia"], correcta: 0 }
  ];
  
  // --- VARIABLES DE ESTADO ---
let nivelActual = 1;
let puntosNivelActual = 0;
let indiceEnNivel = 0;
let puntos = 0; 
let vidas = 3;
let tiempoRestante;
let timerInterval;
let ambitosCompletadosHoy = {
    1: false, // Hogar
    2: false, // Escuela
    3: false, // Empresa
    4: false  // Rescate Vehicular
};
// Recuperamos el progreso guardado para no perder los 10 de ayer
let totalCompletados = parseInt(localStorage.getItem('totalEscenariosSuperados')) || 0;

// --- SONIDOS ---
const sonidoAlarma = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
const sonidoError = new Audio('https://actions.google.com/sounds/v1/emergency/ambulance_siren_distant.ogg');
const sonidoAcierto = new Audio('https://actions.google.com/sounds/v1/cartoon/clime_up_the_ladder.ogg');
const sonidoFuego = new Audio('https://actions.google.com/sounds/v1/ambiences/fire.ogg');
sonidoFuego.loop = true;

window.onload = () => {
    verificarBloqueo();
    mostrarConsejoAlEntrar();
};

function verificarBloqueo() {
    const bloqueoHasta = localStorage.getItem('bloqueoEntrenamiento');
    if (bloqueoHasta && new Date().getTime() < bloqueoHasta) {
        const restante = Math.ceil((bloqueoHasta - new Date().getTime()) / (1000 * 60 * 60));
        bloquearApp(`üö® Entrenamiento suspendido. Vuelve en ${restante} horas para tu pr√≥xima guardia.`);
    }
}

function bloquearApp(mensaje) {
    document.body.innerHTML = `
        <div style="height:100vh; background:#1a1a1a; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; font-family: sans-serif;">
            <h1>üë®‚Äçüöí GUARDi√ÅN DE EMERGENCIAS</h1>
            <p style="font-size:1.5rem; max-width: 600px;">${mensaje}</p>
            <button onclick="localStorage.removeItem('bloqueoEntrenamiento'); location.reload();" style="padding:15px 30px; background:#e63946; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin-top:20px;">REINTENTAR (DEBUG)</button>
        </div>`;
}

function iniciarTimer() { 
    clearInterval(timerInterval);
    tiempoRestante = 30;
    document.getElementById("timer-display").innerText = `‚è±Ô∏è ${tiempoRestante}s`;
    
    timerInterval = setInterval(() => {
        tiempoRestante--;
        document.getElementById("timer-display").innerText = `‚è±Ô∏è ${tiempoRestante}s`;
        if (tiempoRestante <= 5 && tiempoRestante > 0) sonidoAlarma.play();
        if (tiempoRestante <= 0) {
            clearInterval(timerInterval);
            manejarError("¬°TIEMPO AGOTADO!");
        }
    }, 1000);
}

async function iniciarSimulacro() {
    document.getElementById('pantalla-inicio').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    sonidoFuego.play().catch(e => console.log("Audio esperando interacci√≥n"));
    cargarEscenario();
}

// --- FUNCI√ìN CENTRAL DE CARGA ---
async function cargarEscenario() {
    if (vidas <= 0) return;

    // Filtramos solo los escenarios manuales de este nivel
    const escenariosManuales = baseDeDatosEscenarios.filter(e => e.nivel === nivelActual);
    let esc;

    // L√ìGICA DE DECISI√ìN:
    // Si el usuario ya complet√≥ los 30 b√°sicos (totalCompletados >= 30), activar IA.
    // O si en este nivel espec√≠fico ya super√≥ los manuales disponibles.
    if (totalCompletados < 30 && indiceEnNivel < escenariosManuales.length) {
        esc = escenariosManuales[indiceEnNivel];
        renderizarEscenario(esc);
    } 
    else {
        // --- MODO IA ACTIVADO ---
        document.getElementById("scenario-question").innerText = "üîÑ El Bombero IA est√° analizando nuevos riesgos en tiempo real...";
        document.getElementById("options-container").innerHTML = "<p style='color:white'>Estableciendo conexi√≥n con el sat√©lite de emergencias...</p>";
        
        const nombres = ["", "Hogar", "Escuela", "Empresa", "Rescate Vehicular"];
        
        try {
            const respuesta = await fetch('https://guardiandeemergencias.pythonanywhere.com/generar_escenario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ambito: nombres[nivelActual] })
            });
            
            if (!respuesta.ok) throw new Error("Servidor ocupado");
            esc = await respuesta.json();
            renderizarEscenario(esc);
        } catch (error) {
            console.error("Error IA:", error);
            document.getElementById("scenario-question").innerText = "‚ö†Ô∏è Error de red. Reintentando en 3 segundos...";
            setTimeout(cargarEscenario, 3000);
        }
    }
}

// --- ESTA FUNCI√ìN FALTABA ---
function renderizarEscenario(esc) {
    document.getElementById("scenario-question").innerText = esc.escenario;
    const optionsDiv = document.getElementById("options-container");
    optionsDiv.innerHTML = "";
    document.getElementById("feedback").style.display = "none";

    esc.opciones.forEach((texto, index) => {
        const btn = document.createElement("button");
        btn.innerText = texto;
        btn.className = "btn-opcion";
        btn.onclick = () => verificarRespuesta(index, esc);
        optionsDiv.appendChild(btn);
    });
    iniciarTimer();
}

async function verificarRespuesta(indexElegido, objetoEscenario) {
    clearInterval(timerInterval);
    const feedback = document.getElementById("feedback");
    feedback.style.display = "block";

    if (indexElegido === objetoEscenario.correcta) {
        sonidoAcierto.play();
        puntos += 100;
        puntosNivelActual += 100;
        feedback.innerText = "‚úÖ ¬°Correcto! +100 puntos.";
        feedback.style.color = "#2e7d32";
        actualizarInterfaz();
        setTimeout(siguientePregunta, 2000);
    } else {
        feedback.innerText = "‚è≥ Analizando error...";
        feedback.style.color = "#d32f2f";
        manejarError("Respuesta Incorrecta");
        
        try {
            const respuesta = await fetch('https://guardiandeemergencias.pythonanywhere.com/analizar_error', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ error: objetoEscenario.opciones[indexElegido], escenario: objetoEscenario.escenario })
            });
            const data = await respuesta.json();
            feedback.innerText = "üë®‚Äçüöí CONSEJO: " + data.consejo;
        } catch (e) {
            feedback.innerText = "‚ùå Error al obtener consejo.";
        }
        setTimeout(siguientePregunta, 5000);
    }
}

function siguientePregunta() {
    if (vidas > 0 && puntosNivelActual < 1000) {
        indiceEnNivel++;
        cargarEscenario();
    }
}

function manejarError(mensaje) {
    sonidoError.play();
    vidas--;
    actualizarVidasUI();
    if (vidas <= 0) {
        const manana = new Date().getTime() + (24 * 60 * 60 * 1000);
        localStorage.setItem('bloqueoEntrenamiento', manana);
        setTimeout(() => {
            bloquearApp("‚ö†Ô∏è Demasiados errores. Sigue entrenando e int√©ntalo ma√±ana.");
        }, 1500);
    }
}

function actualizarVidasUI() {
    const display = document.getElementById("vidas-display");
    if(display) display.innerText = "‚ù§Ô∏è".repeat(Math.max(0, vidas)) + "üñ§".repeat(Math.max(0, 3 - vidas));
}

function deshabilitarBotonAmbito(num) {
    const botones = document.querySelectorAll('.info-card .main-btn');
    if (botones[num-1]) {
        botones[num-1].disabled = true;
        botones[num-1].innerText = "‚úÖ COMPLETADO";
        botones[num-1].style.background = "#444";
    }
}

function actualizarInterfaz() {
    document.getElementById("txt-puntos").innerText = puntos;
    
    // La barra se llena con los primeros 30 escenarios (3000 puntos)
    const progresoBarra = Math.min((puntos / 3000) * 100, 100);
    document.getElementById("bar-fill").style.width = progresoBarra + "%";

    // ¬øComplet√≥ los 10 escenarios (1000 pts) del √°mbito actual?
    if (puntosNivelActual >= 1000 && !ambitosCompletadosHoy[nivelActual]) {
        ambitosCompletadosHoy[nivelActual] = true;
        totalCompletados += 10;
        localStorage.setItem('totalEscenariosSuperados', totalCompletados);
        
        clearInterval(timerInterval);
        sonidoFuego.pause();
        deshabilitarBotonAmbito(nivelActual);

        // REGLA: Si complet√≥ los 3 √°mbitos b√°sicos (30 escenarios en total)
        if (ambitosCompletadosHoy[1] && ambitosCompletadosHoy[2] && ambitosCompletadosHoy[3]) {
            const manana = new Date().getTime() + (24 * 60 * 60 * 1000);
            localStorage.setItem('bloqueoEntrenamiento', manana);
            alert("üö® ¬°GUARDIA COMPLETADA! Has superado los 30 escenarios b√°sicos. Vuelve ma√±ana para los desaf√≠os infinitos de la IA.");
            location.reload();
        } else {
            alert(`‚úÖ Sector ${nivelActual} asegurado. Elige el siguiente punto de despliegue.`);
            document.getElementById("simulador").style.display = "none";
        }
    }
}

function seleccionarAmbito(num) {
    if (ambitosCompletadosHoy[num]) return;
    nivelActual = num;
    indiceEnNivel = 0; 
    puntosNivelActual = 0; 
    const nombres = ["", "Hogar", "Escuela", "Empresa", "Rescate Vehicular"];
    document.getElementById("txt-nivel").innerText = `Nivel ${num}: ${nombres[num]}`;
    document.getElementById("simulador").style.display = "block";
    iniciarSimulacro();
}

async function mostrarConsejoAlEntrar() {
    try {
        const respuesta = await fetch('https://guardiandeemergencias.pythonanywhere.com/consejo_diario');
        const data = await respuesta.json();
        document.getElementById('texto-consejo-ia').innerText = '"' + data.consejo + '"';
    } catch (error) {
        document.getElementById('texto-consejo-ia').innerText = "La prevenci√≥n es la mejor herramienta.";
    }
}

</script>

<div id="banner-comercial" style="background: linear-gradient(90deg, #1a1a1a, #2c3e50); border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; margin: 30px auto; max-width: 600px; text-align: center; color: white; font-family: sans-serif;">
    <h3 style="margin-top: 0; color: #e74c3c;">üöÄ ¬øQuer√©s llevar este simulador a tu Empresa o Escuela?</h3>
    <p style="font-size: 0.95em; line-height: 1.4;">Estamos desarrollando m√≥dulos avanzados de <b>Accidentes Viales</b> y <b>Materiales Peligrosos</b>.</p>
    
    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
        <a href="https://forms.gle/S7gkFJ77V3cLCWWz9" target="_blank" style="background-color: #e74c3c; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; transition: 0.3s;">Me interesa para mi Instituci√≥n</a>
        
        <a href="https://cafecito.app/emergencyguardian26" target="_blank" style="background-color: #2ecc71; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; transition: 0.3s;">‚òï Apoyar el Proyecto</a>
    </div>
</div>

<footer style="text-align: center; padding: 20px; color: #888; font-size: 0.9em; border-top: 1px solid #333; margin-top: 50px;">
        <p>&copy; 2025 - 2026 **Guardi√°n de Emergencias**. Todos los derechos reservados.</p>
        <p style="font-size: 0.8em;">Prohibida la reproducci√≥n total o parcial de este software, su l√≥gica de simulaci√≥n y contenido educativo sin autorizaci√≥n expresa del autor.</p>
        <p style="font-size: 0.7em; color: #555;">Desarrollado con Inteligencia Artificial aplicada a la Seguridad Civil.</p>
    </footer>
</body>
</html>  
    